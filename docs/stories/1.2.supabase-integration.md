# Story 1.2: Supabase Integration & Database Schema

## Status
Draft

## Story
**As a** developer,
**I want** Supabase PostgreSQL database schema and storage buckets configured,
**so that** the application can persist document metadata and store uploaded/processed files.

## Acceptance Criteria

1. Supabase client libraries integrated (supabase-js for frontend, supabase-py for backend) with environment variable configuration
2. Database table `documents` created with fields: `id` (UUID, PK), `filename` (text), `status` (enum: queued/processing/complete/failed), `processing_options` (JSON), `created_at` (timestamp), `completed_at` (timestamp), `error_message` (text, nullable)
3. Two storage buckets created: `uploads` (original files) and `processed` (markdown files), both configured as private with backend-only access
4. Backend service successfully connects to Supabase and can create test records in `documents` table
5. Backend service can upload/download test files to/from both storage buckets with proper error handling
6. Database migration script or schema documentation provided for reproducible setup

## Tasks / Subtasks

- [ ] Install Supabase client libraries (AC: 1)
  - [ ] Add `@supabase/supabase-js` to frontend dependencies
  - [ ] Add `supabase` (supabase-py) to backend requirements.txt
  - [ ] Install dependencies in both environments
  - [ ] Verify package installations

- [ ] Configure environment variables (AC: 1)
  - [ ] Create `backend/.env.example` with Supabase variable placeholders
  - [ ] Update `frontend/.env.local.example` with Supabase variable placeholders
  - [ ] Document required environment variables in setup guide
  - [ ] Update `backend/app/core/config.py` to load Supabase credentials
  - [ ] Add validation for required environment variables at startup

- [ ] Create database migration script (AC: 2, 6)
  - [ ] Create `backend/supabase/migrations/001_create_documents_table.sql`
  - [ ] Define `documents` table schema with all required fields
  - [ ] Add status enum constraint: ['queued', 'processing', 'complete', 'failed']
  - [ ] Create indexes on status, created_at, and filename for query performance
  - [ ] Add trigger to auto-update `completed_at` when status changes to 'complete'
  - [ ] Document migration execution steps in setup guide

- [ ] Create storage buckets (AC: 3, 6)
  - [ ] Add storage bucket creation to migration script
  - [ ] Create `uploads` bucket (private, 10MB limit, PDF/DOCX/PPTX/XLSX types)
  - [ ] Create `processed` bucket (private, 10MB limit, markdown/text types)
  - [ ] Configure Row Level Security (RLS) policies for bucket access
  - [ ] Document bucket configuration and access patterns

- [ ] Implement Supabase service layer (AC: 1, 4, 5)
  - [ ] Create `backend/app/services/supabase_service.py`
  - [ ] Implement Supabase client initialization with error handling
  - [ ] Create method: `create_document_record(filename, processing_options)` returns document_id
  - [ ] Create method: `update_document_status(document_id, status, error_message=None)`
  - [ ] Create method: `get_document_by_id(document_id)` returns document metadata
  - [ ] Create method: `upload_file_to_bucket(bucket_name, file_path, file_data)` with error handling
  - [ ] Create method: `download_file_from_bucket(bucket_name, file_path)` returns file data
  - [ ] Add comprehensive error handling for all database/storage operations
  - [ ] Add logging for all Supabase operations (debug level)

- [ ] Initialize Supabase client in backend (AC: 1, 4)
  - [ ] Update `backend/app/main.py` to initialize Supabase on startup
  - [ ] Add startup event to verify Supabase connection
  - [ ] Add health check to verify database connectivity
  - [ ] Log successful Supabase initialization

- [ ] Initialize Supabase client in frontend (AC: 1)
  - [ ] Create `frontend/src/lib/supabase.ts` with client initialization
  - [ ] Configure Supabase client with environment variables
  - [ ] Export typed Supabase client for use in components
  - [ ] Add error handling for missing environment variables

- [ ] Create database test suite (AC: 4)
  - [ ] Create `backend/tests/test_supabase_connection.py`
  - [ ] Test: Supabase client initialization succeeds
  - [ ] Test: Create document record with valid data
  - [ ] Test: Update document status (queued → processing → complete)
  - [ ] Test: Retrieve document by ID
  - [ ] Test: Handle invalid document ID gracefully
  - [ ] Test: Validate status enum constraint (reject invalid status)
  - [ ] Use pytest fixtures for test database cleanup

- [ ] Create storage test suite (AC: 5)
  - [ ] Create `backend/tests/test_supabase_storage.py`
  - [ ] Test: Upload file to `uploads` bucket
  - [ ] Test: Download file from `uploads` bucket
  - [ ] Test: Upload file to `processed` bucket
  - [ ] Test: Download file from `processed` bucket
  - [ ] Test: Handle non-existent file download gracefully
  - [ ] Test: Handle upload errors (bucket full, invalid type)
  - [ ] Clean up test files after each test

- [ ] Create Supabase setup documentation (AC: 6)
  - [ ] Create `backend/supabase/setup.md` with step-by-step instructions
  - [ ] Document: Creating Supabase project
  - [ ] Document: Obtaining API keys and project URL
  - [ ] Document: Running migration script via Supabase SQL Editor
  - [ ] Document: Verifying database schema creation
  - [ ] Document: Verifying storage bucket creation
  - [ ] Document: Testing database connection
  - [ ] Include troubleshooting section for common issues

- [ ] Integration testing (AC: 4, 5)
  - [ ] Run full test suite: `pytest backend/tests/test_supabase_*.py`
  - [ ] Verify all tests pass
  - [ ] Test manual workflow: create document → upload file → update status → download file
  - [ ] Verify data persists correctly in Supabase dashboard
  - [ ] Verify files appear in correct storage buckets
  - [ ] Document any environment-specific test requirements

- [ ] Update project documentation (AC: 6)
  - [ ] Update main README with Supabase setup prerequisites
  - [ ] Add Supabase configuration section to development guide
  - [ ] Document environment variable requirements
  - [ ] Add link to detailed Supabase setup guide
  - [ ] Update troubleshooting section with Supabase-specific issues

## Dev Notes

### Previous Story Insights
[Source: Story 1.1 - Project Initialization]
- Monorepo structure established with `/frontend` (Next.js) and `/backend` (FastAPI)
- Both services have health check endpoints
- Environment variable pattern established with `.env.example` files
- Testing frameworks configured (pytest for backend, Vitest for frontend)
- Code formatting and linting configured for both services

### Database Schema Design
[Source: Epic 1.2 AC #2, architecture/tech-stack.md#Database]

**Documents Table:**
```sql
CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    filename TEXT NOT NULL,
    status TEXT NOT NULL CHECK (status IN ('queued', 'processing', 'complete', 'failed')),
    processing_options JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE,
    error_message TEXT,
    file_size BIGINT,
    content_type TEXT,
    processed_file_path TEXT,
    original_file_path TEXT
);
```

**Indexes:**
- `idx_documents_status` - for filtering by status
- `idx_documents_created_at` - for time-based queries
- `idx_documents_filename` - for filename searches

**Trigger:**
- Auto-update `completed_at` timestamp when status changes to 'complete'

### Storage Bucket Configuration
[Source: Epic 1.2 AC #3, architecture/tech-stack.md#File-Storage]

**Uploads Bucket:**
- Name: `uploads`
- Privacy: Private
- Size Limit: 10MB (10485760 bytes)
- Allowed Types: PDF, DOCX, PPTX, XLSX
- Purpose: Store original uploaded documents

**Processed Bucket:**
- Name: `processed`
- Privacy: Private
- Size Limit: 10MB (10485760 bytes)
- Allowed Types: text/markdown, text/plain
- Purpose: Store Docling-processed markdown output

### Supabase Client Libraries
[Source: architecture/tech-stack.md#Client-Libraries]

**Frontend:**
```bash
npm install @supabase/supabase-js
```

**Backend:**
```bash
pip install supabase
```

### Environment Variables
[Source: Epic 1.2 AC #1, architecture/tech-stack.md#Environment-Management]

**Backend (.env):**
```bash
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_KEY=your-service-role-key-here
```

**Frontend (.env.local):**
```bash
NEXT_PUBLIC_SUPABASE_URL=https://your-project-id.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here
```

### Supabase Service Layer Pattern
[Source: architecture/source-tree.md#Backend-Services]

**Service Location:** `backend/app/services/supabase_service.py`

**Key Methods:**
- `create_document_record()` - Create new document metadata
- `update_document_status()` - Update document processing status
- `get_document_by_id()` - Retrieve document metadata
- `upload_file_to_bucket()` - Upload file to storage
- `download_file_from_bucket()` - Download file from storage

**Error Handling:**
- Wrap all Supabase operations in try-except blocks
- Log errors with context (document_id, operation type)
- Return structured error responses
- Distinguish between client errors (400) and server errors (500)

### Testing Strategy
[Source: architecture/coding-standards.md#Testing-Standards]

**Unit Tests:**
- Test database CRUD operations in isolation
- Test storage operations with mock data
- Test error handling for various failure scenarios
- Use pytest fixtures for database cleanup

**Integration Tests:**
- Test full workflow: create → upload → update → download
- Verify data persistence in actual Supabase instance
- Test concurrent operations
- Verify RLS policies work correctly

**Test Files:**
- `tests/test_supabase_connection.py` - Database operations
- `tests/test_supabase_storage.py` - Storage operations
- Use `pytest-asyncio` for async test support

### Row Level Security (RLS)
[Source: Epic 1.2 AC #3, backend/supabase/migrations/001_create_documents_table.sql]

**RLS Policies:**
- Enable RLS on `documents` table
- Allow all operations for workshop use case (no authentication)
- Future enhancement: Add user-based policies when authentication is implemented

**Storage Policies:**
- Backend uses service role key for full access
- Frontend uses anon key (limited operations)
- Both buckets configured as private (no public access)

### Coding Standards
[Source: architecture/coding-standards.md#Backend-Standards]

**Python Standards:**
- Type hints for all function parameters and return values
- Use f-strings for string formatting
- Async/await for I/O operations
- Comprehensive error handling with specific exception types
- Structured logging with context

**File Organization:**
- Service layer in `app/services/`
- Configuration in `app/core/config.py`
- Tests in `tests/` with matching structure
- Migrations in `supabase/migrations/`

### Connection Pooling
[Source: architecture/tech-stack.md#Backend-Optimization]

**Considerations:**
- Supabase-py handles connection pooling automatically
- Configure connection timeout in client initialization
- Monitor connection usage in Supabase dashboard
- Plan for connection limits (free tier: 60 concurrent connections)

### Migration Reproducibility
[Source: Epic 1.2 AC #6]

**Requirements:**
- Migration script must be idempotent (can run multiple times)
- Use `IF NOT EXISTS` for table creation
- Use `ON CONFLICT DO NOTHING` for bucket creation
- Document manual steps (Supabase project creation)
- Version migrations with sequential numbering

### Security Considerations
[Source: architecture/tech-stack.md#Application-Security]

**Key Security Measures:**
- Never expose service role key to frontend
- Use anon key for frontend operations
- Validate file types on both client and server
- Enforce file size limits at database level
- Private storage buckets with RLS policies

### Dependencies
[Source: Previous story context]

**Depends On:**
- Story 1.1 (Project Initialization) - COMPLETED
- Supabase project must be created manually

**Enables:**
- Story 1.4 (Backend File Upload & Storage)
- Story 1.5 (Docling Processing Pipeline)
- All subsequent stories requiring data persistence

### Success Criteria Validation

**Story Complete When:**
1. ✅ Both Supabase client libraries installed and configured
2. ✅ Database schema deployed with all fields and indexes
3. ✅ Storage buckets created with correct permissions
4. ✅ Backend can create/read/update documents table records
5. ✅ Backend can upload/download files to/from both buckets
6. ✅ All tests passing (database + storage)
7. ✅ Setup documentation complete and validated
8. ✅ Manual workflow test successful

### Performance Considerations
[Source: architecture/tech-stack.md#Database-Query-Performance]

**Optimization Notes:**
- Indexes on frequently queried fields (status, created_at)
- Use UUID for primary key (better for distributed systems)
- JSONB for processing_options (flexible, indexable)
- Monitor query performance in Supabase dashboard

### Known Limitations
[Source: Epic context and tech stack]

**MVP Constraints:**
- No authentication required (workshop use case)
- Simple RLS policies (allow all for now)
- Manual Supabase project setup (not automated)
- Single Supabase instance for local development

### Future Enhancements
[Source: architecture/tech-stack.md#Future-Proofing]

**Post-MVP:**
- User authentication and authorization
- User-specific RLS policies
- Automated database migrations
- Connection pooling optimization
- Multi-region support
- Automated backups and disaster recovery

## Validation Checklist

- [ ] All Supabase client libraries installed
- [ ] Environment variables configured in both frontend and backend
- [ ] Migration script executes without errors
- [ ] `documents` table created with correct schema
- [ ] Storage buckets (`uploads` and `processed`) created
- [ ] RLS policies enabled and configured
- [ ] Backend Supabase service layer implemented
- [ ] All database CRUD operations working
- [ ] File upload/download to both buckets working
- [ ] Error handling comprehensive and tested
- [ ] All unit tests passing
- [ ] All integration tests passing
- [ ] Setup documentation complete and accurate
- [ ] Manual workflow test successful
- [ ] Code follows project coding standards
- [ ] All acceptance criteria met